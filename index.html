<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Node Editor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="node.css">
    <link rel="stylesheet" href="option.css">
  </head>
  <body>
    <!-- Header -->
    <header class="header-bar" role="banner">
      <div class="header-title">Node Editor Demo</div>
      <div class="header-actions">
        <button id="btnSettings" class="icon-btn" title="Einstellungen" aria-label="Einstellungen">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.65l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.027 7.027 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.41l-.36 2.54c-.58.22-1.12.52-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L2.7 7.97a.5.5 0 0 0 .12.65l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 13.66a.5.5 0 0 0-.12.65l1.92 3.32c.13.23.4.32.61.22l2.39-.96c.5.41 1.05.74 1.63.94l.36 2.54c.05.24.25.41.49.41h3.8c.24 0 .44-.17.49-.41l.36-2.54c.58-.21 1.12-.52 1.63-.94l2.39.96c.21.1.48.01.61-.22l1.92-3.32a.5.5 0 0 0-.12-.65l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/></svg>
        </button>
        <button id="btnRun" class="icon-btn" title="Simulation" aria-label="Simulation">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>
        </button>
        <button id="btnSave" class="icon-btn" title="Speichern" aria-label="Speichern">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M17 3H5a2 2 0 0 0-2 2v14l4-4h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
        </button>
      </div>
    </header>

    <!-- Canvas Area -->
    <main class="canvas-container">
      <div id="canvasWrapper" class="canvas-wrapper">
        <div id="canvasInner" class="canvas-inner" style="width: 2000px; height: 1200px;">
          <svg id="connections" class="connections-layer" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"></svg>
          <div id="nodesLayer" class="nodes-layer"></div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-modal-close></div>
      <section class="modal-content">
        <header class="modal-header">
          <div id="modalTitle" class="modal-title">Dialog</div>
          <button class="icon-btn" data-modal-close aria-label="Schließen">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.41 1.41L10.59 13.4 4.3 19.7 2.89 18.29 9.17 12 2.89 5.71 4.3 4.3l6.29 6.29 6.29-6.29z"/></svg>
          </button>
        </header>
        <div id="modalBody" class="modal-body"></div>
        <footer class="modal-footer">
          <button class="btn" data-modal-close>Schließen</button>
        </footer>
      </section>
    </div>

    <!-- Classic script for file:// compatibility -->
    <script defer src="script.js"></script>
    <!--
    Previously, we inlined a module here to avoid CORS on file://.
    At your request, this is now replaced with an external classic script.
    -->
    <!--
    <script type="module">
      // NodeUI: node control + optional dragging (module-scoped)
      class NodeUI {
        buildNodeElement(n, { onOpenConfig, onOpenEdit, onOpenHelp, onStartDrag, onConnectToggle, onEnableChange, connectingFromId, connectChecked, dragEnabled = false, onPositionChange, onDragStart, onDragEnd, getScale, controls = {} } = {}) {
          const container = document.createElement('div');
          container.className = 'node-js';
          if (n.state === 'disabled') container.classList.add('disabled');
          container.style.left = n.position.x + 'px';
          container.style.top = n.position.y + 'px';
          container.dataset.nodeId = n.id;
          container.title = `${n.label} ${n.tag || ''}`.trim();

          const option = document.createElement('div');
          option.className = 'option-js';
          option.setAttribute('role', 'button');
          option.setAttribute('tabindex', '0');
          option.setAttribute('aria-label', `${n.label} ${n.tag || ''}`.trim());
          if (n.state === 'disabled') option.setAttribute('aria-disabled', 'true');

          const label = document.createElement('span');
          label.className = 'label';
          label.innerHTML = `${escapeHtml(n.label)}${n.tag ? ` <span class="tag">${escapeHtml(n.tag)}</span>` : ''}`;

          const actions = document.createElement('span');
          actions.className = 'actions';
          const enableCfg = Object.assign({ visible: true, disabled: false }, controls.enableToggle || {});
          const connectCfg = Object.assign({ visible: true, disabled: false }, controls.connectToggle || {});
          const editCfg = Object.assign({ visible: true, disabled: false }, controls.editButton || {});
          const helpCfg = Object.assign({ visible: true, disabled: false }, controls.helpButton || {});

          let enable = null;
          if (enableCfg.visible) {
            enable = document.createElement('label');
            enable.className = 'enable-toggle';
            enable.title = 'Aktivieren/Deaktivieren';
            const enableInput = document.createElement('input');
            enableInput.type = 'checkbox';
            enableInput.checked = n.state !== 'disabled';
            if (enableCfg.disabled) enableInput.disabled = true;
            enableInput.addEventListener('click', (ev) => {
              ev.stopPropagation();
              const nextEnabled = !!enableInput.checked;
              if (typeof onEnableChange === 'function') onEnableChange(n.id, nextEnabled);
            });
            enable.appendChild(enableInput);
          }

          let connect = null;
          if (connectCfg.visible) {
            connect = document.createElement('label');
            connect.className = 'connect-toggle';
            connect.title = 'Verbinden';
            const connectInput = document.createElement('input');
            connectInput.type = 'checkbox';
            connectInput.checked = !!connectChecked;
            if (connectCfg.disabled || n.state === 'disabled') connectInput.disabled = true;
            connectInput.addEventListener('click', (ev) => { ev.stopPropagation(); onConnectToggle && onConnectToggle(n.id, connectInput.checked); });
            connect.appendChild(connectInput);
          }

          let btnEdit = null;
          if (editCfg.visible) {
            btnEdit = document.createElement('button');
            btnEdit.className = 'mini-btn';
            btnEdit.title = 'Bearbeiten';
            btnEdit.setAttribute('aria-label', 'Bearbeiten');
            btnEdit.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>';
            if (editCfg.disabled || n.state === 'disabled') btnEdit.disabled = true;
            btnEdit.addEventListener('click', (ev) => { ev.stopPropagation(); onOpenEdit && onOpenEdit(n.id); });
          }

          let btnHelp = null;
          if (helpCfg.visible) {
            btnHelp = document.createElement('button');
            btnHelp.className = 'mini-btn';
            btnHelp.title = 'Hilfe';
            btnHelp.setAttribute('aria-label', 'Hilfe');
            btnHelp.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 17h-2v-2h2v2zm2.07-7.75-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26a2 2 0 1 0-3.41-1.41H8a4 4 0 1 1 7.07 2.25z"/></svg>';
            if (helpCfg.disabled || n.state === 'disabled') btnHelp.disabled = true;
            btnHelp.addEventListener('click', (ev) => { ev.stopPropagation(); onOpenHelp && onOpenHelp(n.id); });
          }

          if (enable) option.appendChild(enable);
          if (connect) option.appendChild(connect);
          option.appendChild(label);
          if (btnEdit) actions.appendChild(btnEdit);
          if (btnHelp) actions.appendChild(btnHelp);
          option.appendChild(actions);

          if (n.state === 'warning') {
            const badge = document.createElement('span');
            badge.className = 'warning-badge';
            badge.title = 'Unvollständige Konfiguration';
            option.appendChild(badge);
          }

          option.addEventListener('click', () => onOpenConfig && onOpenConfig(n.id));
          option.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onOpenConfig && onOpenConfig(n.id); }
          });
          option.addEventListener('focus', () => option.classList.add('focus-ring'));
          option.addEventListener('blur', () => option.classList.remove('focus-ring'));

          if (dragEnabled) {
            const getScaleSafe = typeof getScale === 'function' ? getScale : () => 1;
            const onMouseDown = (e) => {
              if (e.button !== 0) return;
              if (n.state === 'disabled') return;
              const start = { x: e.clientX, y: e.clientY };
              const orig = { x: n.position.x, y: n.position.y };
              const onMove = (ev) => {
                const scale = getScaleSafe() || 1;
                const dx = (ev.clientX - start.x) / scale;
                const dy = (ev.clientY - start.y) / scale;
                n.position.x = Math.round(orig.x + dx);
                n.position.y = Math.round(orig.y + dy);
                container.style.left = n.position.x + 'px';
                container.style.top = n.position.y + 'px';
                if (typeof onPositionChange === 'function') onPositionChange(n);
                document.dispatchEvent(new CustomEvent('node-position-changed', { detail: { id: n.id, position: { ...n.position } } }));
              };
              const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                if (typeof onDragEnd === 'function') onDragEnd(n);
              };
              document.addEventListener('mousemove', onMove);
              document.addEventListener('mouseup', onUp, { once: true });
              if (typeof onDragStart === 'function') onDragStart(n);
            };
            container.addEventListener('mousedown', onMouseDown);
          } else {
            container.addEventListener('mousedown', (e) => onStartDrag && onStartDrag(e, n.id));
          }

          if (connectingFromId) {
            if (connectingFromId === n.id) option.classList.add('connect-source');
            else option.classList.add('connect-pick');
          }

          container.appendChild(option);
          return container;
        }
        optionSelector(id) { return document.querySelector(`[data-node-id="${id}"] .option-js`); }
      }
      function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

      // App state and data
      const state = { scale: 1, pan: { x: 0, y: 0 }, dragging: null, connectingFrom: null };
      const nodes = new Map([
        ['start', { id: 'start', label: 'Sprachauswahl', tag: '(Start)',  state: 'enabled', position: { x: 160,  y: 220 }, connections: ['menu'] }],
        ['menu',  { id: 'menu',  label: 'Men\u00FC',         tag: '(Weiter)', state: 'enabled', position: { x: 1040, y: 300 }, connections: ['end'] }],
        ['help',  { id: 'help',  label: 'Hilfe',          tag: '',        state: 'warning', position: { x: 240,  y: 640 }, connections: [] }],
        ['end',   { id: 'end',   label: 'Beenden',        tag: '',        state: 'disabled', position: { x: 1480, y: 720 }, connections: [] }],
      ]);

      // DOM refs
      const canvasWrapper = document.getElementById('canvasWrapper');
      const canvasInner   = document.getElementById('canvasInner');
      const nodesLayer    = document.getElementById('nodesLayer');
      const svg           = document.getElementById('connections');

      // Header buttons
      document.getElementById('btnSettings').addEventListener('click', () => openSettings());
      document.getElementById('btnRun').addEventListener('click',      () => runSimulation());
      document.getElementById('btnSave').addEventListener('click',     () => saveDesign());

      // Modal helpers
      const modal     = document.getElementById('modal');
      const modalBody = document.getElementById('modalBody');
      const modalTitle= document.getElementById('modalTitle');
      modal.addEventListener('click', (e) => { if (e.target.matches('[data-modal-close], .modal-backdrop')) closeModal(); });
      function openModal(title, contentNode) { modalTitle.textContent = title; modalBody.innerHTML = ''; if (contentNode) modalBody.appendChild(contentNode); modal.setAttribute('aria-hidden', 'false'); }
      function closeModal() { modal.setAttribute('aria-hidden', 'true'); }

      function openSettings() {
        const div = document.createElement('div');
        div.innerHTML = `<p>Konfigurationsdialog (Platzhalter).</p><ul><li>UI-Skalierung: <code>${state.scale.toFixed(2)}</code></li><li>Pan: <code>(${state.pan.x.toFixed(0)}, ${state.pan.y.toFixed(0)})</code></li><li>Knoten: <code>${nodes.size}</code></li></ul>`;
        openModal('Einstellungen', div);
      }
      function saveDesign() {
        const data = { nodes: Array.from(nodes.values()).map(n => ({ ...n })) };
        const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.textContent = JSON.stringify(data, null, 2);
        openModal('Speichern', pre);
      }

      // Rendering
      const nodesUI = new NodeUI();
      function renderNodes() {
        nodesLayer.innerHTML = '';
        nodes.forEach(n => {
          const el = nodesUI.buildNodeElement(n, {
            onOpenConfig: optionClick,
            onOpenEdit: openEditDialog,
            onOpenHelp: showHelp,
            onConnectToggle: (id, checked) => onConnectToggle(id, checked),
            onEnableChange: (id, enabled) => {
              const node = nodes.get(id); if (!node) return; node.state = enabled ? 'enabled' : 'disabled';
              if (!enabled) { node.lastTarget = Array.isArray(node.connections) && node.connections[0] ? node.connections[0] : node.lastTarget; node.connections = []; if (state.connectingFrom === id) state.connectingFrom = null; }
              renderNodes(); renderConnections();
            },
            connectingFromId: state.connectingFrom,
            connectChecked: state.connectingFrom === n.id || (Array.isArray(n.connections) && n.connections.length > 0),
            dragEnabled: true, getScale: () => state.scale, onPositionChange: () => renderConnections(),
            controls: { enableToggle: { visible: true }, connectToggle: { visible: true }, editButton: { visible: true }, helpButton: { visible: true } },
          });
          nodesLayer.appendChild(el);
        });
      }

      function renderConnections() {
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        svg.setAttribute('width', canvasInner.style.width || '2000px');
        svg.setAttribute('height', canvasInner.style.height || '1200px');
        svg.setAttribute('viewBox', `0 0 ${parseInt(canvasInner.style.width||2000)} ${parseInt(canvasInner.style.height||1200)}`);
        nodes.forEach(n => {
          n.connections.forEach(targetId => {
            const t = nodes.get(targetId); if (!t) return;
            const a = nodeAnchor(n.id); const b = nodeAnchor(t.id);
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', bezierPath(a, b)); path.setAttribute('fill', 'none'); path.setAttribute('stroke', 'var(--blue-600)'); path.setAttribute('stroke-width', '2'); path.setAttribute('marker-end', 'url(#arrow)');
            path.addEventListener('mouseenter', () => path.setAttribute('stroke', '#2563EB'));
            path.addEventListener('mouseleave', () => path.setAttribute('stroke', 'var(--blue-600)'));
            svg.appendChild(path);
          });
        });
        ensureArrowMarker();
      }
      function ensureArrowMarker() { let defs = svg.querySelector('defs'); if (!defs) { defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs'); svg.prepend(defs); } let marker = svg.querySelector('#arrow'); if (!marker) { marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker'); marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','7'); marker.setAttribute('refX','9'); marker.setAttribute('refY','3.5'); marker.setAttribute('orient','auto'); const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon'); poly.setAttribute('points','0 0, 10 3.5, 0 7'); poly.setAttribute('fill','var(--blue-600)'); marker.appendChild(poly); defs.appendChild(marker);} }
      function nodeAnchor(id) { const el = document.querySelector(`[data-node-id="${id}"]`); if (!el) return {x:0,y:0}; const x = parseFloat(el.style.left) + el.offsetWidth/2; const y = parseFloat(el.style.top) + el.offsetHeight/2; return { x, y }; }
      function bezierPath(a,b){ const dx = Math.max(60, Math.abs(b.x-a.x)*0.4); const c1={x:a.x+dx,y:a.y}; const c2={x:b.x-dx,y:b.y}; return `M ${a.x} ${a.y} C ${c1.x} ${c1.y}, ${c2.x} ${c2.y}, ${b.x} ${b.y}`; }

      function onConnectToggle(id, checked){ const current = nodes.get(id); if(!current) return; if (checked && state.connectingFrom && state.connectingFrom !== id){ const from = nodes.get(state.connectingFrom); if (from){ from.connections=[id]; from.lastTarget=id; } state.connectingFrom=null; renderConnections(); renderNodes(); return; } if (checked){ if((!current.connections||current.connections.length===0)&& current.lastTarget && nodes.has(current.lastTarget)){ current.connections=[current.lastTarget]; renderConnections(); renderNodes(); return; } state.connectingFrom=id; renderNodes(); return; } if (state.connectingFrom===id) state.connectingFrom=null; if (Array.isArray(current.connections)&&current.connections.length>0){ current.lastTarget=current.connections[0]; } current.connections=[]; renderConnections(); renderNodes(); }
      function optionClick(id){ if (state.connectingFrom && id !== state.connectingFrom){ const from = nodes.get(state.connectingFrom); if(from){ from.connections=[id]; from.lastTarget=id; } state.connectingFrom=null; renderConnections(); renderNodes(); return; } if (state.connectingFrom && id===state.connectingFrom){ state.connectingFrom=null; renderNodes(); } }

      // Pan/zoom
      canvasWrapper.addEventListener('wheel', (e)=>{ if (e.ctrlKey){ e.preventDefault(); const factor = e.deltaY<0?1.1:0.9; const prev = state.scale; const next = Math.max(0.4, Math.min(2.5, prev*factor)); const rect = canvasWrapper.getBoundingClientRect(); const cx = (e.clientX - rect.left - state.pan.x)/prev; const cy=(e.clientY-rect.top-state.pan.y)/prev; state.pan.x -= cx*(next-prev); state.pan.y -= cy*(next-prev); state.scale=next; applyTransform(); } }, { passive:false });
      let panning=false; let panStart={x:0,y:0};
      canvasWrapper.addEventListener('mousedown',(e)=>{ if (e.target===canvasWrapper || e.target===canvasInner){ panning=true; panStart={x:e.clientX-state.pan.x, y:e.clientY-state.pan.y}; addEventListener('mousemove', onPan); addEventListener('mouseup', endPan, {once:true}); } });
      function onPan(e){ if(!panning) return; state.pan.x = e.clientX - panStart.x; state.pan.y = e.clientY - panStart.y; applyTransform(); }
      function endPan(){ panning=false; removeEventListener('mousemove', onPan); }
      function applyTransform(){ canvasInner.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.scale})`; }

      // Node dialogs
      function openEditDialog(id){ openNodeConfig(id); }
      function openNodeConfig(id){ const n = nodes.get(id); if(!n) return; const wrap = document.createElement('div'); wrap.innerHTML = `
        <div style="display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center;">
          <label>Name</label><input id="cfgLabel" value="${escapeHtml(n.label).replace(/\"/g,'&quot;')}" />
          <label>Tag</label><input id="cfgTag" value="${escapeHtml(n.tag||'').replace(/\"/g,'&quot;')}" />
          <label>Status</label>
          <select id="cfgState">
            <option value="enabled" ${n.state==='enabled'?'selected':''}>aktiv</option>
            <option value="disabled" ${n.state==='disabled'?'selected':''}>inaktiv</option>
            <option value="warning" ${n.state==='warning'?'selected':''}>Warnung</option>
          </select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;"><button class="btn" id="cfgSave">Speichern</button></div>`;
        openModal(`Knoten: ${n.label}`, wrap);
        wrap.querySelector('#cfgSave').addEventListener('click', ()=>{ n.label = wrap.querySelector('#cfgLabel').value; n.tag = wrap.querySelector('#cfgTag').value; n.state = wrap.querySelector('#cfgState').value; renderNodes(); renderConnections(); closeModal(); });
      }
      function showHelp(id){ const n = nodes.get(id); const div = document.createElement('div'); div.innerHTML = `<p>Hilfe zu <strong>${escapeHtml(n?.label || id)}</strong>.</p><p class="muted">Hier k\u00F6nnten Tooltips oder Dokumentation stehen.</p>`; openModal('Hilfe', div); }

      // Run/highlight
      function runSimulation(){ const startNode = Array.from(nodes.values()).find(n => (n.tag||'').toLowerCase().includes('start')) || nodes.values().next().value; const visited=new Set(); const path=[]; let current=startNode; while(current && !visited.has(current.id)){ path.push(current.id); visited.add(current.id); current = nodes.get(current.connections[0]); } let i=0; const timer=setInterval(()=>{ if(i>0){ const prev=document.querySelector(`[data-node-id="${path[i-1]}"] .option-js`); if(prev) prev.style.background='var(--blue-900)'; } if(i>=path.length){ clearInterval(timer); return; } const el=document.querySelector(`[data-node-id="${path[i]}"] .option-js`); if(el) el.style.background='#0E9F6E'; i++; },400); }

      // Initial render
      renderNodes(); renderConnections(); applyTransform();
      addEventListener('resize', () => { renderConnections(); });
    </script>
    -->
  </body>
  </html>
